<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Activity Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-md p-8">

            <!-- Header -->
            <div class="mb-6 pb-4 border-b">
                <h1 class="text-3xl font-bold text-gray-800">üìä Daily Activity Report</h1>
                <p class="text-gray-600">Team hours summary by client ‚Äî <span class="text-blue-600 font-medium">click any hours cell or total to see full details</span></p>
            </div>

            <!-- Filters -->
            <div class="mb-6 p-6 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
                <h2 class="text-xl font-bold text-blue-900 mb-4">üîç Filters</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="filterDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client</label>
                        <select id="filterClient" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Clients</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Employee</label>
                        <select id="filterUser" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                            üìä Load Report
                        </button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetFilters()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">Reset</button>
                    <button onclick="setToday()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">Today</button>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="mb-6 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-600 rounded-lg">
                <h3 class="text-lg font-bold text-blue-900 mb-4">üìà Summary</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-600 mb-1">Total Planned</p>
                        <p class="text-2xl font-bold text-blue-600" id="totalPlanned">0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-600 mb-1">Total Clockify</p>
                        <p class="text-2xl font-bold text-purple-600" id="totalClockify">0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-600 mb-1">Total Effective</p>
                        <p class="text-2xl font-bold text-green-600" id="totalEffective">0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-600 mb-1">Total Billed</p>
                        <p class="text-2xl font-bold text-orange-600" id="totalBilled">0.00</p>
                    </div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="mb-4 flex gap-2 flex-wrap">
                <button onclick="showView('planned')"   id="btnPlanned"   class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">Planned Hours</button>
                <button onclick="showView('clockify')"  id="btnClockify"  class="bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg">Clockify Hours</button>
                <button onclick="showView('effective')" id="btnEffective" class="bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg">Effective Hours</button>
                <button onclick="showView('billed')"    id="btnBilled"    class="bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg">Billed Hours</button>
            </div>

            <!-- Status -->
            <div id="statusMessage" class="mb-4 hidden"></div>

            <!-- Matrix Table -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300" id="matrixTable">
                    <thead>
                        <tr class="bg-blue-600 text-white">
                            <th class="border border-gray-300 p-3 text-left font-semibold sticky left-0 bg-blue-600">Client</th>
                        </tr>
                    </thead>
                    <tbody id="matrixBody">
                        <tr>
                            <td colspan="100" class="text-center p-8 text-gray-500">Click "Load Report" to view data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========== DETAIL MODAL ========== -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4" style="display:none;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">

            <!-- Modal Header -->
            <div class="p-6 border-b bg-blue-600 rounded-t-xl flex items-start justify-between">
                <div>
                    <h2 class="text-xl font-bold text-white" id="modalTitle">Activity Details</h2>
                    <p class="text-blue-100 text-sm mt-1" id="modalSubtitle"></p>
                </div>
                <button onclick="closeModal()" class="text-white hover:text-blue-200 text-3xl font-bold leading-none ml-4">&times;</button>
            </div>

            <!-- Modal Summary Bar -->
            <div class="px-6 py-4 bg-blue-50 border-b grid grid-cols-4 gap-4">
                <div class="text-center">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Planned</p>
                    <p class="text-xl font-bold text-blue-600" id="modalTotalPlanned">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Clockify</p>
                    <p class="text-xl font-bold text-purple-600" id="modalTotalClockify">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Effective</p>
                    <p class="text-xl font-bold text-green-600" id="modalTotalEffective">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Billed</p>
                    <p class="text-xl font-bold text-orange-600" id="modalTotalBilled">-</p>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="overflow-y-auto flex-1 p-6" id="modalContent">
                <p class="text-gray-400 text-center">Loading...</p>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t flex justify-end">
                <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-8 rounded-lg transition">Close</button>
            </div>
        </div>
    </div>

    <script>
        const REPORT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw61B6jNnrquGFItO4pkauWs9CDaIoNdStb7uWFD7ggHr2F2adZOY2rzLiDvAp4vog3/exec';

        let matrixData = [];
        let rawRows    = [];
        let currentView = 'planned';
        let allClients = [];
        let allUsers   = [];

        window.addEventListener('load', async () => {
            await loadFilterOptions();
            setToday();
        });

        async function loadFilterOptions() {
            try {
                const res    = await fetch(REPORT_SCRIPT_URL + '?action=getFilterOptions');
                const result = await res.json();
                if (result.status === 'success') {
                    populateSelect('filterClient', result.clients);
                    populateSelect('filterUser',   result.users);
                }
            } catch (err) {
                showStatus('Error loading filters: ' + err.message, 'error');
            }
        }

        function populateSelect(id, items) {
            const sel = document.getElementById(id);
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = item;
                sel.appendChild(opt);
            });
        }

        function setToday() {
            document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
        }

        function resetFilters() {
            ['filterDate','filterClient','filterUser'].forEach(id => document.getElementById(id).value = '');
        }

        async function loadReport() {
            showStatus('Loading report...', 'info');
            const date   = document.getElementById('filterDate').value;
            const client = document.getElementById('filterClient').value;
            const user   = document.getElementById('filterUser').value;

            try {
                let url = REPORT_SCRIPT_URL + '?action=getMatrixData';
                if (date)   url += '&date='   + encodeURIComponent(date);
                if (client) url += '&client=' + encodeURIComponent(client);
                if (user)   url += '&user='   + encodeURIComponent(user);

                const res    = await fetch(url);
                const result = await res.json();

                if (result.status === 'success') {
                    matrixData = result.data;
                    rawRows    = result.rawRows || [];
                    allClients = result.clients;
                    allUsers   = result.users;
                    buildMatrix(allClients, allUsers);
                    calculateTotals();
                    showStatus('Report loaded successfully!', 'success');
                    setTimeout(hideStatus, 3000);
                } else {
                    showStatus('Error: ' + result.message, 'error');
                }
            } catch (err) {
                showStatus('Error loading report: ' + err.message, 'error');
            }
        }

        function buildMatrix(clients, users) {
            const thead = document.querySelector('#matrixTable thead tr');
            const tbody = document.getElementById('matrixBody');
            thead.innerHTML = '<th class="border border-gray-300 p-3 text-left font-semibold sticky left-0 bg-blue-600 z-10">Client</th>';
            tbody.innerHTML = '';

            if (!clients.length || !users.length) {
                tbody.innerHTML = '<tr><td colspan="100" class="text-center p-8 text-gray-500">No data found for selected filters</td></tr>';
                return;
            }

            users.forEach(u => {
                const th = document.createElement('th');
                th.className = 'border border-gray-300 p-3 text-center font-semibold';
                th.textContent = u;
                thead.appendChild(th);
            });
            const thTot = document.createElement('th');
            thTot.className = 'border border-gray-300 p-3 text-center font-semibold bg-blue-700';
            thTot.textContent = 'Total';
            thead.appendChild(thTot);

            clients.forEach(client => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                const cTd = document.createElement('td');
                cTd.className = 'border border-gray-300 p-3 font-semibold bg-gray-50 sticky left-0';
                cTd.textContent = client;
                tr.appendChild(cTd);

                let rowTotal = 0;
                users.forEach(user => {
                    const td  = document.createElement('td');
                    const dp  = matrixData.find(d => d.client === client && d.user === user);
                    const val = dp ? getViewValue(dp) : 0;

                    if (val > 0) {
                        td.textContent = val.toFixed(2);
                        td.className   = 'border border-gray-300 p-3 text-center font-semibold text-blue-700 cursor-pointer hover:bg-blue-100 transition-colors duration-150';
                        td.title       = `Click to see details for ${user} ‚Üí ${client}`;
                        td.addEventListener('click', () => openDetailModal(client, user, `${client}  ¬∑  ${user}`));
                        rowTotal += val;
                    } else {
                        td.textContent = '-';
                        td.className   = 'border border-gray-300 p-3 text-center text-gray-300';
                    }
                    tr.appendChild(td);
                });

                // Row total ‚Äî clickable
                const rtd = document.createElement('td');
                if (rowTotal > 0) {
                    rtd.textContent = rowTotal.toFixed(2);
                    rtd.className   = 'border border-gray-300 p-3 text-center font-bold bg-blue-100 text-blue-900 cursor-pointer hover:bg-blue-200 transition-colors duration-150';
                    rtd.title       = `Click to see all activities for ${client}`;
                    rtd.addEventListener('click', () => openDetailModal(client, null, `All employees  ¬∑  ${client}`));
                } else {
                    rtd.textContent = '-';
                    rtd.className   = 'border border-gray-300 p-3 text-center font-bold bg-blue-100 text-blue-900';
                }
                tr.appendChild(rtd);
                tbody.appendChild(tr);
            });

            // Totals row
            const totTr = document.createElement('tr');
            totTr.className = 'bg-blue-100 font-bold';
            const totLabel = document.createElement('td');
            totLabel.className = 'border border-gray-300 p-3 font-bold bg-blue-200 sticky left-0';
            totLabel.textContent = 'Total';
            totTr.appendChild(totLabel);

            users.forEach(user => {
                const td = document.createElement('td');
                let col = 0;
                matrixData.forEach(d => { if (d.user === user) col += getViewValue(d); });

                if (col > 0) {
                    td.textContent = col.toFixed(2);
                    td.className   = 'border border-gray-300 p-3 text-center font-bold text-blue-900 cursor-pointer hover:bg-blue-200 transition-colors duration-150';
                    td.title       = `Click to see all activities for ${user}`;
                    td.addEventListener('click', () => openDetailModal(null, user, `${user}  ¬∑  All clients`));
                } else {
                    td.textContent = '-';
                    td.className   = 'border border-gray-300 p-3 text-center font-bold text-blue-900';
                }
                totTr.appendChild(td);
            });

            // Grand total ‚Äî clickable
            const gtd = document.createElement('td');
            let grand = 0;
            matrixData.forEach(d => grand += getViewValue(d));
            if (grand > 0) {
                gtd.textContent = grand.toFixed(2);
                gtd.className   = 'border border-gray-300 p-3 text-center font-bold bg-blue-200 text-blue-900 cursor-pointer hover:bg-blue-300 transition-colors duration-150';
                gtd.title       = 'Click to see ALL activities';
                gtd.addEventListener('click', () => openDetailModal(null, null, 'All clients  ¬∑  All employees'));
            } else {
                gtd.textContent = '-';
                gtd.className   = 'border border-gray-300 p-3 text-center font-bold bg-blue-200 text-blue-900';
            }
            totTr.appendChild(gtd);
            tbody.appendChild(totTr);
        }

        function getViewValue(dp) {
            return { planned: dp.plannedHours, clockify: dp.clockifyHours, effective: dp.effectiveHours, billed: dp.billedHours }[currentView] || 0;
        }

        function calculateTotals() {
            let p=0, c=0, e=0, b=0;
            matrixData.forEach(d => { p+=d.plannedHours; c+=d.clockifyHours; e+=d.effectiveHours; b+=d.billedHours; });
            document.getElementById('totalPlanned').textContent   = p.toFixed(2);
            document.getElementById('totalClockify').textContent  = c.toFixed(2);
            document.getElementById('totalEffective').textContent = e.toFixed(2);
            document.getElementById('totalBilled').textContent    = b.toFixed(2);
        }

        function showView(view) {
            currentView = view;
            ['planned','clockify','effective','billed'].forEach(v => {
                const btn = document.getElementById('btn' + v.charAt(0).toUpperCase() + v.slice(1));
                btn.className = v === view
                    ? 'bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg'
                    : 'bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg';
            });
            if (matrixData.length) buildMatrix(allClients, allUsers);
        }

        // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openDetailModal(client, user, title) {
            let rows = rawRows;
            if (client) rows = rows.filter(r => r.client === client);
            if (user)   rows = rows.filter(r => r.user   === user);

            document.getElementById('modalTitle').textContent = title;
            const dateVal = document.getElementById('filterDate').value;
            document.getElementById('modalSubtitle').textContent =
                (dateVal ? `Date: ${dateVal}` : 'All dates in current filter') +
                `  ¬∑  ${rows.length} activit${rows.length === 1 ? 'y' : 'ies'}`;

            let tp=0, tc=0, te=0, tb=0;
            rows.forEach(r => { tp+=r.plannedHours; tc+=r.clockifyHours; te+=r.effectiveHours; tb+=r.billedHours; });
            document.getElementById('modalTotalPlanned').textContent   = tp.toFixed(2);
            document.getElementById('modalTotalClockify').textContent  = tc.toFixed(2);
            document.getElementById('modalTotalEffective').textContent = te.toFixed(2);
            document.getElementById('modalTotalBilled').textContent    = tb.toFixed(2);

            const content = document.getElementById('modalContent');

            if (!rows.length) {
                content.innerHTML = '<p class="text-gray-400 text-center p-8">No activity rows found.</p>';
            } else {
                const showClient = !client;
                const showUser   = !user;

                let html = `
                <table class="w-full border-collapse text-sm">
                    <thead class="sticky top-0 z-10">
                        <tr class="bg-gray-100 text-gray-600 uppercase text-xs">
                            <th class="border border-gray-300 p-2 text-left whitespace-nowrap">Date</th>
                            ${showClient ? '<th class="border border-gray-300 p-2 text-left">Client</th>' : ''}
                            ${showUser   ? '<th class="border border-gray-300 p-2 text-left">Employee</th>' : ''}
                            <th class="border border-gray-300 p-2 text-left">Project</th>
                            <th class="border border-gray-300 p-2 text-left">Activity Description</th>
                            <th class="border border-gray-300 p-2 text-center text-blue-700 whitespace-nowrap">Planned</th>
                            <th class="border border-gray-300 p-2 text-center text-purple-700 whitespace-nowrap">Clockify</th>
                            <th class="border border-gray-300 p-2 text-center text-green-700 whitespace-nowrap">Effective</th>
                            <th class="border border-gray-300 p-2 text-center text-orange-700 whitespace-nowrap">Billed</th>
                        </tr>
                    </thead>
                    <tbody>`;

                rows.forEach((row, i) => {
                    html += `
                    <tr class="${i%2===0?'bg-white':'bg-gray-50'} hover:bg-blue-50 transition-colors">
                        <td class="border border-gray-300 p-2 text-gray-600 whitespace-nowrap">${row.date || '-'}</td>
                        ${showClient ? `<td class="border border-gray-300 p-2 text-gray-800 font-medium">${row.client || '-'}</td>` : ''}
                        ${showUser   ? `<td class="border border-gray-300 p-2 text-gray-800 font-medium">${row.user || '-'}</td>` : ''}
                        <td class="border border-gray-300 p-2 font-semibold text-indigo-700">${row.project || '-'}</td>
                        <td class="border border-gray-300 p-2 text-gray-700">${row.activity || '-'}</td>
                        <td class="border border-gray-300 p-2 text-center text-blue-700 font-semibold">${row.plannedHours   > 0 ? row.plannedHours.toFixed(2)   : '-'}</td>
                        <td class="border border-gray-300 p-2 text-center text-purple-700 font-semibold">${row.clockifyHours  > 0 ? row.clockifyHours.toFixed(2)  : '-'}</td>
                        <td class="border border-gray-300 p-2 text-center text-green-700 font-semibold">${row.effectiveHours > 0 ? row.effectiveHours.toFixed(2) : '-'}</td>
                        <td class="border border-gray-300 p-2 text-center text-orange-700 font-semibold">${row.billedHours    > 0 ? row.billedHours.toFixed(2)    : '-'}</td>
                    </tr>`;
                });

                const extraCols = (showClient ? 1 : 0) + (showUser ? 1 : 0);
                html += `
                    </tbody>
                    <tfoot>
                        <tr class="bg-blue-100 font-bold text-sm">
                            <td class="border border-gray-300 p-2" colspan="${3 + extraCols}">Total (${rows.length} rows)</td>
                            <td class="border border-gray-300 p-2 text-center text-blue-800">${tp.toFixed(2)}</td>
                            <td class="border border-gray-300 p-2 text-center text-purple-800">${tc.toFixed(2)}</td>
                            <td class="border border-gray-300 p-2 text-center text-green-800">${te.toFixed(2)}</td>
                            <td class="border border-gray-300 p-2 text-center text-orange-800">${tb.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>`;
                content.innerHTML = html;
            }

            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        function showStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            const c  = { success:'bg-green-100 border-green-400 text-green-800', error:'bg-red-100 border-red-400 text-red-800', info:'bg-blue-100 border-blue-400 text-blue-800' };
            el.className = `p-4 border rounded-lg ${c[type]}`;
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function hideStatus() { document.getElementById('statusMessage').classList.add('hidden'); }
    </script>
</body>
</html>
